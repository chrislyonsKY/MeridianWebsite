# CLAUDE.md — The Meridian

> **themeridian.news** — News, neutrally synthesized.

This document is the single source of truth for The Meridian project. It contains everything needed to understand, modify, and extend the codebase. Read this before making any changes.

-----

## Table of Contents

1. [Project Overview](#project-overview)
1. [Architecture](#architecture)
1. [Tech Stack](#tech-stack)
1. [Directory Structure](#directory-structure)
1. [Data Flow](#data-flow)
1. [Database Schema](#database-schema)
1. [Authentication System](#authentication-system)
1. [LLM Integration](#llm-integration)
1. [The Neutrality Engine](#the-neutrality-engine)
1. [News Ingestion Pipeline](#news-ingestion-pipeline)
1. [Frontend Architecture](#frontend-architecture)
1. [Design System](#design-system)
1. [API Routes](#api-routes)
1. [Deployment & Infrastructure](#deployment--infrastructure)
1. [Testing](#testing)
1. [Feature Roadmap](#feature-roadmap)
1. [Key Decisions & Rationale](#key-decisions--rationale)
1. [Content & Brand Voice](#content--brand-voice)
1. [Known Limitations](#known-limitations)
1. [Development Conventions](#development-conventions)

-----

## Project Overview

The Meridian is a public-facing news platform that:

1. Ingests articles from 15+ sources across the political spectrum every 2 hours
1. Clusters articles by story using LLM intelligence
1. Produces neutral, fact-first summaries via carefully engineered prompts
1. Shows where sources agree and diverge, with editorial lean indicators
1. Lets users personalize topic preferences and subscribe to email digests

**Core differentiator**: Transparency. We don’t just summarize — we show *how* each source covered the story, flag divergences, and display editorial lean. The user judges for themselves.

**Target audience**: News-literate readers who want to understand coverage patterns without toggling between 6 tabs.

**Business model (future)**: Free reading always. Premium features (deeper analysis, custom source sets, API access) may be added later. No ads, no sponsors.

-----

## Architecture

Single-deployment Next.js application on Vercel. Everything — frontend, API, pipeline — lives in one codebase.

```
┌─────────────────────────────────────────────────────────────┐
│                    NEXT.JS 14 (App Router)                  │
│              Deployed on Vercel (Free Tier)                  │
│              Domain: themeridian.news                        │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │  React UI   │  │  API Routes  │  │  Vercel Cron      │  │
│  │  Styled     │  │  /api/stories│  │  0 */2 * * *      │  │
│  │  Components │  │  /api/cron   │  │  Triggers pipeline│  │
│  └──────┬──────┘  └──────┬───────┘  └────────┬──────────┘  │
│         │                │                    │             │
│  ┌──────┴────────────────┴────────────────────┘             │
│  │                                                          │
│  │  ┌─────────────────────────────────────────────────┐     │
│  │  │              PIPELINE SERVICES                  │     │
│  │  │                                                 │     │
│  │  │  fetchAllSources() ─► insertArticles()          │     │
│  │  │        │                    │                    │     │
│  │  │        ▼                    ▼                    │     │
│  │  │  clusterArticles() ─► summarizeStory()          │     │
│  │  │        │                    │                    │     │
│  │  │        ▼                    ▼                    │     │
│  │  │  createStory() ──── updateStory(published)      │     │
│  │  └─────────────────────────────────────────────────┘     │
│  │                                                          │
│  │  ┌──────────────┐         ┌────────────────┐             │
│  │  │   Supabase   │         │  LLM Provider  │             │
│  │  │  (Postgres)  │         │  Claude/OpenAI  │             │
│  │  │  + Auth      │         │  (swappable)    │             │
│  │  └──────────────┘         └────────────────┘             │
│  │                                                          │
│  └──────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────┘
```

-----

## Tech Stack

|Layer       |Choice             |Why                                                    |
|------------|-------------------|-------------------------------------------------------|
|Framework   |Next.js 14         |App Router, API routes, SSR, single codebase           |
|Language    |TypeScript         |Type safety across pipeline, DB queries, and components|
|Styling     |Styled Components  |Component-scoped CSS-in-JS, theme support, SSR compat  |
|Database    |Supabase (Postgres)|Free tier, built-in auth, RLS, realtime, REST API      |
|Auth        |Supabase Auth      |Email/password + Google OAuth, session management      |
|LLM         |Claude + OpenAI    |Provider-agnostic abstraction, switchable via env var  |
|News Sources|NewsAPI + GNews    |Two API providers for redundancy, plus RSS fallback    |
|Hosting     |Vercel             |Free tier, serverless, auto-scaling, cron jobs         |
|Fonts       |Google Fonts       |Playfair Display (headlines) + DM Sans (body)          |
|Icons       |Lucide React       |Consistent, lightweight icon set                       |

-----

## Directory Structure

```
the-meridian/
├── src/
│   ├── app/                          # Next.js App Router pages & routes
│   │   ├── layout.tsx                # Root layout: providers stack
│   │   ├── page.tsx                  # Home: story feed + contextual prompts
│   │   ├── about/page.tsx            # About page
│   │   ├── methodology/page.tsx      # Methodology page
│   │   ├── auth/
│   │   │   ├── callback/route.ts     # OAuth redirect handler
│   │   │   └── reset-password/page.tsx # Password reset form
│   │   └── api/
│   │       ├── stories/route.ts      # GET stories (filtered, paginated)
│   │       └── cron/route.ts         # Pipeline trigger (Vercel Cron)
│   │
│   ├── components/
│   │   ├── auth/                     # Complete auth system
│   │   │   ├── AuthProvider.tsx      # Context: session, profile, all auth methods
│   │   │   ├── AuthModal.tsx         # Sign in / Sign up / Forgot password modal
│   │   │   ├── OnboardingModal.tsx   # Post-signup: topics + digest preferences
│   │   │   ├── UserMenu.tsx          # Signed-in dropdown (avatar, prefs, sign out)
│   │   │   ├── ContextualSignIn.tsx  # Inline prompt for gated features
│   │   │   └── index.ts             # Barrel export
│   │   ├── layout/
│   │   │   ├── Header.tsx            # Masthead, nav, search, theme toggle, auth
│   │   │   └── Footer.tsx            # Links, branding
│   │   ├── story/
│   │   │   └── StoryCard.tsx         # Story with expandable source details
│   │   ├── theme/
│   │   │   └── ThemeProvider.tsx      # Light/dark mode context + SC provider
│   │   └── ui/
│   │       └── ContentStyles.tsx     # Shared styled components for content pages
│   │
│   ├── lib/
│   │   ├── api/
│   │   │   └── news-sources.ts       # NewsAPI, GNews, RSS fetchers + normalizer
│   │   ├── db/
│   │   │   ├── supabase.ts           # Server/browser Supabase clients
│   │   │   ├── auth-client.ts        # SSR-compatible auth clients
│   │   │   └── queries.ts            # All DB query functions
│   │   ├── llm/
│   │   │   ├── client.ts             # Provider-agnostic LLM interface
│   │   │   └── prompts.ts            # Clustering + neutrality prompts
│   │   ├── services/
│   │   │   └── pipeline.ts           # Full ingestion orchestrator
│   │   └── registry.tsx              # Styled-components SSR registry
│   │
│   ├── types/
│   │   ├── index.ts                  # All TypeScript types
│   │   └── styled.d.ts              # SC theme type declaration
│   │
│   ├── styles/
│   │   └── GlobalStyles.ts           # Global CSS (fonts, scrollbar, animations)
│   │
│   └── tests/
│       ├── test-news-apis.ts         # Step 1: Validate news API keys
│       ├── test-supabase.ts          # Step 2: Validate DB connectivity
│       ├── test-llm.ts              # Step 3: Validate LLM + neutrality output
│       └── test-pipeline.ts          # Step 4: Full end-to-end pipeline
│
├── supabase/
│   └── migrations/
│       ├── 001_initial_schema.sql    # Sources, articles, stories, story_articles
│       └── 002_user_profiles.sql     # Profiles, user_topics, auto-create trigger
│
├── .env.local.example
├── .gitignore
├── next.config.js
├── package.json
├── tsconfig.json
├── vercel.json                       # Cron schedule + security headers
├── CLAUDE.md                         # This file
└── README.md
```

-----

## Data Flow

### Ingestion Pipeline (runs every 2 hours via Vercel Cron)

```
1. FETCH
   NewsAPI (50 articles) + GNews (10 articles) + RSS feeds
   ↓
2. NORMALIZE
   Map to common NormalizedArticle shape, deduplicate by URL
   ↓
3. MATCH SOURCES
   Look up each article's source in our DB by name
   Skip articles from sources we don't track
   ↓
4. STORE
   Upsert into `articles` table (conflict on URL)
   ↓
5. CLUSTER
   Send all new article headlines/snippets to LLM
   LLM groups them by underlying story
   Output: { headline, topic, article_indices }[]
   Skip clusters with < 2 articles
   ↓
6. SUMMARIZE
   For each cluster, send article details to neutrality prompt
   LLM returns: headline, summary, key_facts, divergence_summary, source_snippets
   ↓
7. PUBLISH
   Create story record → link articles → save summary → set status='published'
```

### Read Path (user loads homepage)

```
1. Browser loads / → page.tsx (client component)
2. Fetches GET /api/stories?topic=X&page=1
3. API route calls getPublishedStories() on Supabase
4. Returns stories with nested story_articles → articles → sources
5. StoryCard renders summary, expandable source details
```

-----

## Database Schema

### Tables

**sources** — News outlets we track

- `id` UUID PK
- `name` TEXT UNIQUE
- `url` TEXT
- `rss_url` TEXT nullable
- `bias_rating` ENUM — left | center-left | center | center-right | right
- `logo_url` TEXT nullable
- `is_active` BOOLEAN
- `created_at` TIMESTAMPTZ

**articles** — Individual news articles

- `id` UUID PK
- `source_id` UUID FK → sources
- `title` TEXT
- `url` TEXT UNIQUE — dedupe key
- `snippet` TEXT nullable
- `author` TEXT nullable
- `image_url` TEXT nullable
- `published_at` TIMESTAMPTZ
- `ingested_at` TIMESTAMPTZ

**stories** — Clustered, summarized story groups

- `id` UUID PK
- `headline` TEXT — neutral headline from LLM
- `summary` TEXT nullable
- `topic` ENUM — politics | technology | world | science | business | health | sports | entertainment | general
- `key_facts` JSONB — string array
- `divergence_summary` TEXT nullable
- `source_count` INTEGER
- `llm_provider` ENUM — claude | openai
- `status` ENUM — pending | summarized | published | archived
- `created_at`, `updated_at` TIMESTAMPTZ

**story_articles** — Junction table

- `story_id` UUID FK → stories
- `article_id` UUID FK → articles
- `source_snippet` TEXT nullable — LLM characterization of source’s angle
- PK: (story_id, article_id)

**profiles** — User profiles (extends auth.users)

- `id` UUID PK FK → auth.users
- `name` TEXT nullable
- `avatar_url` TEXT nullable
- `digest_frequency` ENUM — daily | weekly | none
- `onboarding_complete` BOOLEAN
- `created_at`, `updated_at` TIMESTAMPTZ

**user_topics** — User topic preferences

- `user_id` UUID FK → profiles
- `topic` ENUM (same as stories.topic)
- PK: (user_id, topic)

### Row Level Security

- **sources, articles**: Public read access
- **stories**: Public read WHERE status = ‘published’
- **story_articles**: Public read
- **profiles, user_topics**: Users read/write own rows only
- All tables: Service role has full access

### Triggers

- `on_auth_user_created`: Auto-creates a `profiles` row when a user signs up

### Migrations (run in order)

1. `001_initial_schema.sql` — Core tables + 15 seeded sources
1. `002_user_profiles.sql` — User profiles + topic preferences + trigger

### Current Source Ratings

|Rating      |Sources                                                                   |
|------------|--------------------------------------------------------------------------|
|Left        |CNN                                                                       |
|Center-Left |BBC News, NPR, The Guardian, The Washington Post, The New York Times      |
|Center      |Reuters, Associated Press, Bloomberg, CNBC, Politico, The Hill, Al Jazeera|
|Center-Right|The Wall Street Journal, Financial Times                                  |
|Right       |Fox News                                                                  |

-----

## Authentication System

### Flow

```
Signed Out (default) ─── all content readable, no gates
    │
    ├── "Sign in" button ──► AuthModal (signin mode)
    │                         ├─ Email + Password
    │                         ├─ Google OAuth
    │                         ├─ "Forgot password?" ──► forgot mode ──► email sent
    │                         └─ "Sign up" toggle ──► signup mode
    │
    ├── Contextual prompt ──► AuthModal (signup mode)
    │   (topic prefs, digest)
    │
    └── Google OAuth ──► /auth/callback ──► redirect back

Sign Up completes ──► OnboardingModal auto-opens
    ├── Step 1: Select topics (8 options, multi-select)
    ├── Step 2: Choose digest frequency (daily/weekly/none)
    └── "Start reading" ──► saves prefs, closes modal

Signed In ──► UserMenu replaces "Sign in" button
    ├── Preferences ──► re-opens OnboardingModal
    ├── Digest settings ──► re-opens OnboardingModal
    └── Sign out ──► clears session

Password Reset:
    ├── User clicks reset link in email
    ├── Lands on /auth/reset-password
    ├── Enters new password (with confirmation)
    └── Success ──► link back to homepage
```

### Gated Features (only these require an account)

- Personalized topic preferences
- Email digest subscription

Everything else works without an account.

### Component Architecture

|Component       |File                                  |Purpose                                  |
|----------------|--------------------------------------|-----------------------------------------|
|AuthProvider    |`components/auth/AuthProvider.tsx`    |Session state, auth methods, profile CRUD|
|AuthModal       |`components/auth/AuthModal.tsx`       |Sign in / up / forgot password modal     |
|OnboardingModal |`components/auth/OnboardingModal.tsx` |Post-signup topic + digest flow          |
|UserMenu        |`components/auth/UserMenu.tsx`        |Signed-in dropdown                       |
|ContextualSignIn|`components/auth/ContextualSignIn.tsx`|Inline prompt for gated features         |

### Supabase Auth Setup

1. Enable Email provider (default)
1. Enable Google OAuth (requires Google Cloud Console credentials)
1. Site URL: `https://themeridian.news`
1. Redirect URLs: `*/auth/callback`, `*/auth/reset-password`

-----

## LLM Integration

### Provider Abstraction (`lib/llm/client.ts`)

```typescript
complete(systemPrompt, userPrompt, options?) → { content, provider, model, usage }
completeJSON<T>(systemPrompt, userPrompt, options?) → { data: T, provider, model }
```

- Default provider: `LLM_PROVIDER` env var (`claude` | `openai`)
- Claude model: `claude-sonnet-4-20250514`
- OpenAI model: `gpt-4o`
- Temperature: 0.2-0.3 (low, for factual consistency)
- JSON mode: Strips markdown fences, retries parsing

-----

## The Neutrality Engine

Two prompts in `lib/llm/prompts.ts`. This is the core IP.

### Clustering Prompt

Groups articles by underlying story. Input: headlines + snippets. Output: clusters with neutral headline, topic, and article indices. Minimum 2 sources per cluster.

### Neutrality Summarization Prompt

**Absolute rules enforced:**

1. Report only verifiable factual claims
1. Neutral language — banned words: slammed, blasted, controversial, bombshell, stunning, historic, admitted (use acknowledged), demanded (use called for)
1. Attribution on disagreement: “Source A reported X, while Source B characterized it as Y”
1. Structure: What happened → Context → What’s next
1. Source snippets: One sentence per source describing their angle
1. Divergence: Explicit when sources disagree; null when they agree

**Output**: `{ headline, summary, key_facts, divergence_summary, source_snippets }`

**Changes to `SUMMARY_SYSTEM_PROMPT` should be treated like changes to core business logic — test thoroughly.**

-----

## News Ingestion Pipeline

### Source Fetchers (`lib/api/news-sources.ts`)

- **NewsAPI**: Top headlines + everything endpoint, 50 articles/call
- **GNews**: Top headlines + search, 10 articles/call
- **RSS**: Generic parser for any feed URL

`fetchAllSources()` runs all in parallel, normalizes, deduplicates by URL.

### Pipeline (`lib/services/pipeline.ts`)

`runIngestionPipeline()`: fetch → match sources → upsert articles → cluster → summarize → publish

`DEFAULT_BIAS_MAP` maps source names to bias ratings as fallback.

-----

## Frontend Architecture

### Provider Stack (layout.tsx)

```
<StyledComponentsRegistry>      ← SSR style collection
  <AppThemeProvider>             ← Light/dark theme + SC ThemeProvider
    <AuthProvider>               ← Session, profile, auth methods
      <GlobalStyles />           ← Fonts, resets, animations
      {children}
    </AuthProvider>
  </AppThemeProvider>
</StyledComponentsRegistry>
```

### Key Patterns

- All page components are `'use client'`
- Data fetching via `fetch()` to API routes (client-side)
- Auth state via `useAuth()` hook
- Theme via `useThemeMode()` + SC `theme` prop
- Modals controlled by parent state (Header owns AuthModal)

-----

## Design System

### Typography

|Role     |Font            |Weights |Usage                           |
|---------|----------------|--------|--------------------------------|
|Headlines|Playfair Display|400, 700|Masthead, headlines, blockquotes|
|Body     |DM Sans         |300-700 |Everything else                 |
|Mono     |DM Mono         |400     |Code blocks, rules              |

### Colors

|Token        |Light  |Dark   |Usage          |
|-------------|-------|-------|---------------|
|bg           |#FFFFFF|#0F0F0F|Page background|
|text         |#111827|#E5E5E5|Primary text   |
|textSecondary|#4B5563|#A3A3A3|Body text      |
|accent       |#991B1B|#EF4444|Brand red, CTAs|
|border       |#E5E7EB|#262626|Subtle borders |
|borderStrong |#111827|#E5E5E5|Double rules   |

### Bias Indicator Colors

|Lean        |Color  |
|------------|-------|
|Left        |#3B82F6|
|Center-Left |#60A5FA|
|Center      |#6B7280|
|Center-Right|#F87171|
|Right       |#EF4444|

### Layout

- Max content width: 780px
- Prose max width: 640px
- Header/footer: 3px double border
- Story cards stagger in with 0.08s delay

-----

## API Routes

### `GET /api/stories`

Params: `topic`, `page`, `pageSize`, `q` (search)

Response: `{ stories, total, page, pageSize }`

### `GET /api/cron`

Protected by `CRON_SECRET`. Triggers full pipeline.

Response: `{ success, articlesIngested, storiesCreated, errors, timestamp }`

-----

## Deployment & Infrastructure

### Vercel (Free Tier)

- Auto-deploy from GitHub
- Cron: `/api/cron` every 2 hours (`0 */2 * * *`)
- Security headers configured in `vercel.json`
- Domain: `themeridian.news` → add in Vercel project settings, point DNS

### Environment Variables

```
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
LLM_PROVIDER=claude
NEWSAPI_KEY=...
GNEWS_API_KEY=...
CRON_SECRET=<random-string>
```

### Cost

|Service      |Plan        |Monthly Cost    |
|-------------|------------|----------------|
|Vercel       |Free (Hobby)|$0              |
|Supabase     |Free        |$0              |
|NewsAPI      |Free (dev)  |$0              |
|GNews        |Free        |$0              |
|Anthropic API|Pay-per-use |~$5-15          |
|**Total**    |            |**~$5-15/month**|

### Launch Checklist

1. Push to GitHub
1. Import to Vercel → add env vars → deploy
1. Create Supabase project → run both migrations
1. Get API keys (NewsAPI, GNews, Anthropic/OpenAI)
1. Run test sequence: `test:apis` → `test:db` → `test:llm` → `test:pipeline`
1. Add `themeridian.news` domain in Vercel
1. Point DNS to Vercel
1. Go live

-----

## Testing

```bash
npm run test:apis      # Validates NewsAPI/GNews keys
npm run test:db        # Validates Supabase tables + seed data
npm run test:llm       # Tests neutrality prompt + banned word check
npm run test:pipeline  # Full end-to-end (live data, costs LLM tokens)
```

Test 3 includes automated neutrality check: scans output for banned words (slammed, blasted, controversial, bombshell, stunning, historic, landmark, sweeping).

-----

## Feature Roadmap

### Completed

- [x] Database schema (2 migrations)
- [x] News ingestion (NewsAPI + GNews + RSS)
- [x] LLM abstraction (Claude + OpenAI)
- [x] Neutrality prompts (clustering + summarization)
- [x] Pipeline orchestration
- [x] Home page (story feed, topic nav, search)
- [x] StoryCard with expandable source details
- [x] Light/dark theme system
- [x] Auth system (email/password + Google OAuth)
- [x] Forgot password flow
- [x] Post-signup onboarding (topics + digest)
- [x] User menu + contextual sign-in prompts
- [x] About page
- [x] Methodology page
- [x] Test harness (4 stages)
- [x] Vercel deployment config

### Next

- [ ] Story detail page (`/story/[id]`)
- [ ] Source Index page (`/sources`)
- [ ] Email digest system (Resend or SendGrid)
- [ ] Personalized feed ordering
- [ ] Mobile responsiveness pass
- [ ] SEO (dynamic OG tags per story)
- [ ] RSS output (`/feed.xml`)
- [ ] Error boundaries + loading skeletons

### Future

- [ ] Additional news sources
- [ ] Story “evolution” tracking
- [ ] Bias scoring per story
- [ ] Public API for researchers

-----

## Key Decisions & Rationale

|Decision                       |Why                                                                      |
|-------------------------------|-------------------------------------------------------------------------|
|Styled Components over Tailwind|Theme tokens via `theme` prop, dynamic `$active` props, co-located styles|
|Supabase over raw Postgres     |Built-in auth, RLS, free tier, JS SDK                                    |
|Provider-agnostic LLM          |Avoids lock-in, enables quality comparison                               |
|2-hour cron, not real-time     |Stories benefit from settling; more sources = better synthesis           |
|Multi-source minimum (2+)      |Cross-referencing is the core value; single-source = no divergence       |
|Optional auth                  |Reading should never be gated; auth is a value-add                       |
|Vercel over WordPress          |Single codebase, single deployment, no middleware layer                  |

-----

## Content & Brand Voice

**Name**: The Meridian
**Tagline**: News, neutrally synthesized
**Domain**: themeridian.news

|Do                                |Don’t                              |
|----------------------------------|-----------------------------------|
|State facts plainly               |Editorialize or interpret          |
|Use neutral verbs (said, stated)  |Use loaded verbs (slammed, blasted)|
|Attribute disagreements to sources|Take sides                         |
|Acknowledge limitations openly    |Pretend to be perfect              |
|Link to original reporting        |Reproduce full article text        |

**Key phrases**: “A fixed point of reference in a noisy media landscape” · “Not a replacement for journalism — a companion to it” · “Transparency invites accountability” · “Divergence isn’t a bug — it’s the most valuable signal” · “AI as tool, not author”

-----

## Known Limitations

1. **English-language, Western-media bias** — 15 sources, mostly US/UK outlets
1. **AI hallucination risk** — mitigated by low temperature, not eliminated
1. **Speed vs. depth** — 2-hour cycles; breaking news may have fewer sources initially
1. **Bias rating subjectivity** — based on third-party ratings, inherently imperfect
1. **Selection bias** — multi-source requirement favors stories major outlets cover
1. **No original reporting** — synthesizes, does not investigate
1. **Copyright dependency** — uses snippets/headlines, not full text

-----

## Development Conventions

### Code Style

- TypeScript strict mode — no `any` without justification
- Imports: `@/` path aliases
- Components: PascalCase files, styled components above component function
- Types centralized in `src/types/index.ts`

### Naming

- DB columns: `snake_case`
- TS types: `PascalCase`
- Props: `camelCase`
- SC transient props: `$` prefix (`$active`, `$delay`)

### Git

- Branch: `main`
- Commits: Conventional (`feat:`, `fix:`, `refactor:`, `docs:`)

### Environment

- Node 18+, npm, `npm run dev` on port 3000

-----

*Last updated: February 22, 2026*
*Project status: Scaffold complete — ready for deployment*